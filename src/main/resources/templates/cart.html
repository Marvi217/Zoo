<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale.language}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{cart.title} + ' - PetMarket'">Koszyk - PetMarket</title>
    <link rel="stylesheet" href="/css/public-styles.css">
</head>
<body>
<div th:replace="~{fragments/header :: navbar}"></div>
<div th:replace="~{fragments/header :: categoryBar}"></div>

<!-- BREADCRUMB -->
<div class="breadcrumb">
    <a th:href="@{/}" th:text="#{breadcrumb.home}">Strona g≈Ç√≥wna</a> /
    <span th:text="#{cart.title}">Koszyk</span>
</div>

<!-- MAIN CONTENT -->
<div class="container">
    <h1 class="page-title" th:text="#{cart.title}">Koszyk</h1>

    <!-- EMPTY CART STATE -->
    <div th:if="${cart == null or cart.items.isEmpty()}" class="empty-cart">
        <div class="empty-icon">üõí</div>
        <h2 th:text="#{cart.empty}">Tw√≥j koszyk jest pusty</h2>
        <a th:href="@{/}" class="btn-primary" th:text="#{cart.empty.cta}">Przejd≈∫ do sklepu</a>
    </div>

    <!-- CART WITH ITEMS -->
    <div th:if="${cart != null and !cart.items.isEmpty()}" class="cart-layout">

        <!-- CART ITEMS -->
        <div class="cart-items">
            <div class="cart-header">
                <div th:text="#{cart.product}">Produkt</div>
                <div th:text="#{cart.price}">Cena</div>
                <div th:text="#{cart.quantity}">Ilo≈õƒá</div>
                <div th:text="#{cart.total}">Suma</div>
                <div></div>
            </div>

            <div th:each="item : ${cart.items}" class="cart-item">
                <div class="item-product">
                    <div class="item-image">
                        <img th:if="${item.product.imageUrl != null and !item.product.imageUrl.isEmpty()}"
                             th:src="${item.product.imageUrl}" th:alt="${item.product.name}">
                        <span th:if="${item.product.imageUrl == null or item.product.imageUrl.isEmpty()}">ü¶¥</span>
                    </div>
                    <div class="item-details">
                        <h3 class="item-name" th:text="${item.product.name}">Nazwa produktu</h3>
                        <p class="item-brand" th:if="${item.product.brand != null}"
                           th:text="${item.product.brand.name}">Marka</p>
                    </div>
                </div>

                <div class="item-price" th:data-label="#{cart.price} + ':'">
                    <!-- For BuyXGetY promotions, show promo description only when promo is applied -->
                    <span class="promo-badge" th:if="${item.promoApplied}"
                          th:text="${item.product.buyXGetYDescription}">Kup 2 dosta≈Ñ 1 gratis</span>
                    <!-- Show info when BuyXGetY exists but not yet applied -->
                    <span class="promo-hint" th:if="${item.product.buyXGetYPromotion and !item.promoApplied}"
                          th:text="'Dodaj ' + (item.product.buyXGetYTotalQuantity - item.quantity) + ' wiƒôcej dla promocji'">Dodaj wiƒôcej dla promocji</span>
                    <!-- For regular discounts, show old price crossed out -->
                    <span class="old-price" th:if="${item.product.hasDiscount and !item.product.buyXGetYPromotion}"
                          th:text="${#numbers.formatDecimal(item.product.oldPrice, 1, 2)} + ' ' + #{general.currency}">0.00 z≈Ç</span>
                    <span class="current-price"
                          th:text="${#numbers.formatDecimal(item.price, 1, 2)} + ' ' + #{general.currency}">0.00 z≈Ç</span>
                </div>

                <div class="item-quantity">
                    <div class="quantity-form">
                        <button type="button" class="qty-btn" th:data-product-id="${item.product.id}" th:data-action="decrease" onclick="updateCartQuantity(this)">‚àí</button>
                        <input type="number" th:value="${item.quantity}" min="1" max="10" readonly class="qty-input">
                        <button type="button" class="qty-btn" th:data-product-id="${item.product.id}" th:data-action="increase" onclick="updateCartQuantity(this)">+</button>
                    </div>
                </div>

                <div class="item-total" th:data-label="#{cart.total} + ':'"
                     th:text="${#numbers.formatDecimal(item.totalPrice, 1, 2)} + ' ' + #{general.currency}">0.00 z≈Ç</div>

                <div class="item-actions">
                    <a th:href="@{/cart/remove/{id}(id=${item.product.id})}" class="btn-remove" th:title="#{cart.remove}">
                        üóëÔ∏è
                    </a>
                </div>
            </div>

            <!-- CART ACTIONS -->
            <div class="cart-actions">
                <button type="button" class="btn-secondary" onclick="clearCart()" th:text="#{cart.clear}">Wyczy≈õƒá koszyk</button>
                <a th:href="@{/}" class="btn-outline" th:text="#{cart.continue}">Kontynuuj zakupy</a>
            </div>
        </div>

        <!-- CART SUMMARY -->
        <div class="cart-summary">
            <h2 th:text="#{cart.summary}">Podsumowanie</h2>

            <!-- Product list in summary -->
            <div class="summary-products">
                <div th:each="item : ${cart.items}" class="summary-product-row">
                    <div class="summary-product-info">
                        <span class="summary-product-name" th:text="${item.product.name}">Produkt</span>
                        <span class="summary-product-qty" th:text="'√ó ' + ${item.quantity}">√ó 1</span>
                    </div>
                    <div class="summary-product-prices">
                        <!-- Show original price if discounted (but not for BuyXGetY) -->
                        <span th:if="${item.product.hasDiscount and !item.product.buyXGetYPromotion}" class="summary-original-price"
                              th:text="${#numbers.formatDecimal(item.product.oldPrice * item.quantity, 1, 2)} + ' ' + #{general.currency}">0.00 z≈Ç</span>
                        <!-- Current price -->
                        <span class="summary-product-price" th:text="${#numbers.formatDecimal(item.totalPrice, 1, 2)} + ' ' + #{general.currency}">0.00 z≈Ç</span>
                    </div>
                </div>
            </div>

            <div class="summary-row">
                <span th:text="#{cart.subtotal}">Warto≈õƒá produkt√≥w</span>
                <span th:text="${#numbers.formatDecimal(cart.subtotal, 1, 2)} + ' ' + #{general.currency}">0.00 z≈Ç</span>
            </div>

            <!-- Show discount row if any items have discount -->
            <div th:if="${cart.totalDiscount != null and cart.totalDiscount > 0}" class="summary-row summary-discount">
                <span th:text="#{cart.discount}">Upust</span>
                <span th:text="'-' + ${#numbers.formatDecimal(cart.totalDiscount, 1, 2)} + ' ' + #{general.currency}">-0.00 z≈Ç</span>
            </div>

            <div class="summary-row">
                <span th:text="#{cart.delivery}">Dostawa</span>
                <span th:if="${cart.deliveryCost > 0}"
                      th:text="${#numbers.formatDecimal(cart.deliveryCost, 1, 2)} + ' ' + #{general.currency}">15.00 z≈Ç</span>
                <span th:if="${cart.deliveryCost == 0}" th:text="#{cart.free}">Gratis</span>
            </div>

            <div class="summary-total">
                <span th:text="#{cart.order.total}">Do zap≈Çaty</span>
                <span th:text="${#numbers.formatDecimal(cart.totalAmount, 1, 2)} + ' ' + #{general.currency}">0.00 z≈Ç</span>
            </div>

            <a th:href="@{/checkout}" class="btn-checkout" th:text="#{cart.checkout}">
                Przejd≈∫ do kasy
            </a>
        </div>
    </div>
</div>

<!-- FOOTER -->
<footer>
    <p th:text="#{footer.copyright}">&copy; 2026 PetMarket - Wszystkie prawa zastrze≈ºone</p>
</footer>

<script>
function updateCartQuantity(button) {
    const productId = button.getAttribute('data-product-id');
    const action = button.getAttribute('data-action');
    
    button.disabled = true;
    
    const params = new URLSearchParams();
    params.append('productId', productId);
    params.append('action', action);
    
    fetch('/cart/update', {
        method: 'POST',
        body: params,
        headers: { 
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest' 
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to show updated cart
            window.location.reload();
        } else {
            alert(data.message || 'WystƒÖpi≈Ç b≈ÇƒÖd');
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        button.disabled = false;
    });
}

function clearCart() {
    if (!confirm('Czy na pewno chcesz wyczy≈õciƒá koszyk?')) {
        return;
    }
    
    fetch('/cart/clear-async', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest' 
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.message || 'WystƒÖpi≈Ç b≈ÇƒÖd');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas czyszczenia koszyka');
    });
}
</script>

</body>
</html>