<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale.language}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${category.name} + ' - PetMarket'">Kategoria - PetMarket</title>
    <link rel="stylesheet" href="/css/public-styles.css">
</head>
<body>
<div th:replace="~{fragments/header :: navbar}"></div>
<div th:replace="~{fragments/header :: categoryBar}"></div>

<!-- BREADCRUMB -->
<div class="breadcrumb">
    <a th:href="@{/}" th:text="#{breadcrumb.home}">Strona g≈Ç√≥wna</a> /
    <span th:text="${category.name}">Kategoria</span>
</div>

<!-- MAIN CONTENT -->
<div class="container">
    <div class="category-header">
        <div>
            <h1 class="category-title" th:text="${category.name}">Subkategoria</h1>
            <p class="category-count">
                <span th:text="${totalProducts}">0</span>
                <span th:text="#{category.products}">produkt√≥w</span>
            </p>
        </div>
    </div>

    <div class="category-layout">

        <!-- FILTERS SIDEBAR -->
        <aside class="sidebar">
            <div id="filterContainer">
                <!-- Mobile close button -->
                <button type="button" class="mobile-filter-close" onclick="toggleFilters()">‚úï</button>

                <!-- SUBCATEGORIES SECTION - only show items with products > 0 -->
                <div class="filter-section" th:if="${subCategories != null and !subCategories.isEmpty()}">
                    <h3 class="filter-title" th:text="#{category.filter.subcategories}">Subkategorie</h3>
                    <div class="filter-group" id="subcategoryFilters">
                        <th:block th:each="sub, stat : ${subCategories}">
                            <label class="filter-option" th:if="${sub.productCount > 0}">
                                <input type="checkbox" name="subcategory" th:value="${sub.id}"
                                       th:checked="${selectedSubcategories.contains(sub.id)}"
                                       onchange="applyFiltersAsync()">
                                <span th:text="${sub.name}">Subkategoria</span>
                                <span class="filter-count" th:text="'(' + ${sub.productCount} + ')'"></span>
                            </label>
                        </th:block>
                    </div>
                </div>

                <!-- BRANDS SECTION - only show items with products > 0, collapsible after 5 -->
                <div class="filter-section" th:if="${brandFilters != null and !brandFilters.isEmpty()}">
                    <h3 class="filter-title" th:text="#{category.filter.brand}">Marki</h3>
                    <div class="filter-group" id="brandFilters">
                        <th:block th:each="brand, stat : ${brandFilters}">
                            <label class="filter-option" th:if="${brand.count > 0}"
                                   th:classappend="${stat.index >= 5} ? 'brand-hidden'">
                                <input type="checkbox" name="brands" th:value="${brand.id}"
                                       th:checked="${selectedBrands.contains(brand.id)}"
                                       onchange="applyFiltersAsync()">
                                <span th:text="${brand.name}">Marka</span>
                                <span class="filter-count" th:text="'(' + ${brand.count} + ')'"></span>
                            </label>
                        </th:block>
                    </div>
                    <button type="button" class="btn-expand-filters" id="expandBrandsBtn"
                            onclick="toggleBrandsList()" th:text="#{category.filter.expand}">Rozwi≈Ñ</button>
                </div>

                <!-- PRICE RANGE SECTION -->
                <div class="filter-section">
                    <h3 class="filter-title" th:text="#{category.filter.price}">Cena</h3>
                    <div class="price-inputs">
                        <input type="number" id="minPriceInput" th:placeholder="#{category.filter.price.min}"
                               th:value="${currentMinPrice}" min="0" step="1">
                        <span>-</span>
                        <input type="number" id="maxPriceInput" th:placeholder="#{category.filter.price.max}"
                               th:value="${currentMaxPrice}" min="0" step="1">
                        <span th:text="#{general.currency}">z≈Ç</span>
                    </div>
                </div>

                <!-- APPLY FILTERS BUTTON -->
                <div class="filter-actions">
                    <button type="button" class="btn-apply-filters" onclick="applyFiltersAsync()" th:text="#{category.filter.apply}">Zastosuj filtry</button>
                    <a th:href="@{/category/{slug}(slug=${category.slug})}" class="btn-clear-filters" th:text="#{category.filter.clear}">Wyczy≈õƒá</a>
                </div>
            </div>
        </aside>

        <!-- PRODUCTS SECTION -->
        <div class="products-section">

            <!-- SORTING BAR ABOVE PRODUCTS -->
            <div class="sorting-bar">
                <div class="sorting-info">
                    <span th:text="#{category.showing}">Wy≈õwietlanie</span>
                    <strong th:text="${totalProducts}">0</strong>
                    <span th:text="#{category.products}">produkt√≥w</span>
                </div>
                <div class="sort-controls">
                    <label th:text="#{category.sort}">Sortuj:</label>
                    <select id="sortSelect" onchange="updateSort(this.value)">
                        <option value="default" th:selected="${currentSort == 'default' or currentSort == null}"
                                th:text="#{category.sort.default}">Domy≈õlnie</option>
                        <option value="price-asc" th:selected="${currentSort == 'price-asc'}"
                                th:text="#{category.sort.price.asc}">Cena: rosnƒÖco</option>
                        <option value="price-desc" th:selected="${currentSort == 'price-desc'}"
                                th:text="#{category.sort.price.desc}">Cena: malejƒÖco</option>
                        <option value="name-asc" th:selected="${currentSort == 'name-asc'}"
                                th:text="#{category.sort.name.asc}">Nazwa: A-Z</option>
                        <option value="name-desc" th:selected="${currentSort == 'name-desc'}"
                                th:text="#{category.sort.name.desc}">Nazwa: Z-A</option>
                        <option value="rating" th:selected="${currentSort == 'rating'}"
                                th:text="#{category.sort.rating}">Ocena</option>
                    </select>
                </div>
            </div>

            <!-- ACTIVE FILTERS TAGS -->
            <div class="active-filters" th:if="${!activeFilters.isEmpty()}">
                <span th:each="filter : ${activeFilters}" class="filter-tag">
                    <span th:text="${filter.label}">Filtr</span>
                </span>
            </div>

            <!-- PRODUCTS GRID -->
            <div th:if="${!products.isEmpty()}" class="products-grid">
                <a th:each="product : ${products}"
                   th:href="@{/product/{id}(id=${product.id})}"
                   class="product-card">

                    <!-- Discount Badge -->
                    <div th:if="${product.hasDiscount and !product.buyXGetYPromotion and product.discountPercent > 0}" class="product-badge"
                         th:text="'-' + ${product.discountPercent} + '%'">-25%</div>
                    <div th:if="${product.buyXGetYPromotion}" class="product-badge"
                         th:text="'%'">%</div>

                    <div class="product-image">
                        <img th:if="${product.mainImageUrl != null and product.mainImageUrl.startsWith('/products/')}"
                             th:src="${product.mainImageUrl}" th:alt="${product.name}"
                             style="max-width: 100%; max-height: 180px; object-fit: contain;">
                        <span th:if="${product.mainImageUrl == null or !product.mainImageUrl.startsWith('/products/')}"
                              style="font-size: 64px;">ü¶¥</span>
                    </div>

                    <div class="product-info">
                        <h3 class="product-name" th:text="${product.name}">Nazwa produktu</h3>

                        <p class="product-desc" th:text="${product.shortDescription}">Opis produktu</p>

                        <div class="product-footer">
                            <div class="product-pricing">
                                <span class="old-price" th:if="${product.hasDiscount and !product.buyXGetYPromotion}"
                                      th:text="${#numbers.formatDecimal(product.oldPrice, 1, 2)} + ' ' + #{general.currency}">0.00 z≈Ç</span>
                                <span class="product-price"
                                      th:text="${#numbers.formatDecimal(product.currentPrice, 1, 2)} + ' ' + #{general.currency}">0.00 z≈Ç</span>
                            </div>

                            <form th:action="@{/cart/add}" method="post" style="margin: 0;">
                                <input type="hidden" name="productId" th:value="${product.id}">
                                <input type="hidden" name="quantity" value="1">
                                <button type="submit"
                                        class="btn-add-cart"
                                        th:disabled="${!product.available}"
                                        title="Do koszyka">
                                    üõí
                                </button>
                            </form>
                        </div>
                    </div>
                </a>
            </div>

            <!-- EMPTY STATE -->
            <div th:if="${products.isEmpty()}" class="empty-state">
                <div class="empty-icon">üì¶</div>
                <h2 class="empty-title" th:text="#{search.no.results}">Brak wynik√≥w</h2>
                <p class="empty-text">Spr√≥buj zmieniƒá filtry lub wr√≥ƒá do strony g≈Ç√≥wnej</p>
                <a th:href="@{/}" class="btn-primary" th:text="#{breadcrumb.home}">Strona g≈Ç√≥wna</a>
            </div>

            <!-- PAGINATION -->
            <div class="pagination" th:if="${productPage.totalPages > 1}">
                <a th:if="${productPage.number > 0}"
                   th:data-page="${productPage.number - 1}"
                   onclick="goToPage(this.getAttribute('data-page'))"
                   class="pagination-btn" style="cursor: pointer;">‚Üê Poprzednia</a>
                <span class="pagination-info">
                    <span th:text="${productPage.number + 1}">1</span> / <span th:text="${productPage.totalPages}">1</span>
                </span>
                <a th:if="${productPage.number < productPage.totalPages - 1}"
                   th:data-page="${productPage.number + 1}"
                   onclick="goToPage(this.getAttribute('data-page'))"
                   class="pagination-btn" style="cursor: pointer;">Nastƒôpna ‚Üí</a>
            </div>
        </div>
    </div>
</div>

<!-- Mobile filter button -->
<button class="mobile-filter-btn" onclick="toggleFilters()" th:text="#{category.filter.show}">üîç Filtry</button>

<!-- FOOTER -->
<footer>
    <p th:text="#{footer.copyright}">&copy; 2026 PetMarket - Wszystkie prawa zastrze≈ºone</p>
</footer>

<script th:inline="javascript">
    const categorySlug = /*[[${category.slug}]]*/ '';
    let brandsExpanded = false;

    // Hide expand button if less than 6 brands
    document.addEventListener('DOMContentLoaded', function() {
        const hiddenBrands = document.querySelectorAll('.brand-hidden');
        const expandBtn = document.getElementById('expandBrandsBtn');
        if (hiddenBrands.length === 0 && expandBtn) {
            expandBtn.style.display = 'none';
        }
    });

    function toggleBrandsList() {
        const hiddenBrands = document.querySelectorAll('.brand-hidden');
        const expandBtn = document.getElementById('expandBrandsBtn');
        brandsExpanded = !brandsExpanded;

        hiddenBrands.forEach(brand => {
            brand.style.display = brandsExpanded ? 'flex' : 'none';
        });

        expandBtn.textContent = brandsExpanded ? 'Zwi≈Ñ' : 'Rozwi≈Ñ';
    }

    function applyFiltersAsync() {
        // Collect selected subcategories
        const subcategoryCheckboxes = document.querySelectorAll('#subcategoryFilters input[type="checkbox"]:checked');
        const subcategories = Array.from(subcategoryCheckboxes).map(cb => cb.value);

        // Collect selected brands
        const brandCheckboxes = document.querySelectorAll('#brandFilters input[type="checkbox"]:checked');
        const brands = Array.from(brandCheckboxes).map(cb => cb.value);

        // Get price range
        const minPrice = document.getElementById('minPriceInput')?.value;
        const maxPrice = document.getElementById('maxPriceInput')?.value;

        // Get current sort
        const sortSelect = document.getElementById('sortSelect');
        const sort = sortSelect ? sortSelect.value : 'default';

        // Build URL with parameters
        const url = new URL(window.location.origin + '/category/' + categorySlug);

        subcategories.forEach(id => url.searchParams.append('subcategory', id));
        brands.forEach(id => url.searchParams.append('brands', id));
        if (minPrice) url.searchParams.set('minPrice', minPrice);
        if (maxPrice) url.searchParams.set('maxPrice', maxPrice);
        url.searchParams.set('sort', sort);

        // Navigate to filtered URL
        window.location.href = url.toString();
    }

    function updateSort(sortValue) {
        applyFiltersAsync();
    }

    function goToPage(pageNum) {
        const url = new URL(window.location.href);
        url.searchParams.set('page', pageNum);
        window.location.href = url.toString();
    }

    function toggleFilters() {
        const sidebar = document.querySelector('.sidebar');
        sidebar.classList.toggle('mobile-open');
    }
</script>

</body>
</html>