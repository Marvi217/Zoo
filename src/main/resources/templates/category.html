<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale.language}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${category.name} + ' - PetMarket'">Kategoria - PetMarket</title>
    <link rel="stylesheet" href="/css/public-styles.css">
</head>
<body>
<div th:replace="~{fragments/header :: navbar}"></div>
<div th:replace="~{fragments/header :: categoryBar}"></div>

<!-- BREADCRUMB -->
<div class="breadcrumb">
    <a th:href="@{/}" th:text="#{breadcrumb.home}">Strona g≈Ç√≥wna</a> /
    <span th:text="${category.name}">Kategoria</span>
</div>

<!-- MAIN CONTENT -->
<div class="container">
    <div class="category-header">
        <div>
            <h1 class="category-title" th:text="${category.name}">Subkategoria</h1>
            <p class="category-count">
                <span th:text="${totalProducts}">0</span>
                <span th:text="#{category.products}">produkt√≥w</span>
            </p>
        </div>
    </div>

    <div class="category-layout">

        <!-- FILTERS SIDEBAR -->
        <aside class="sidebar">
            <form id="filterForm" method="get" th:action="@{/category/{slug}(slug=${category.slug})}">
                <!-- Mobile close button -->
                <button type="button" class="mobile-filter-close" onclick="toggleFilters()">‚úï</button>
                
                <!-- SUBCATEGORIES SECTION -->
                <div class="filter-section" th:if="${subCategories != null and !subCategories.isEmpty()}">
                    <h3 class="filter-title" th:text="#{category.filter.subcategories}">Subkategorie</h3>
                    <div class="filter-group">
                        <label class="filter-option" th:each="sub : ${subCategories}">
                            <input type="checkbox" name="subcategory" th:value="${sub.id}"
                                   th:checked="${selectedSubcategories.contains(sub.id)}">
                            <span th:text="${sub.name}">Subkategoria</span>
                            <span class="filter-count" th:text="'(' + ${sub.productCount} + ')'"></span>
                        </label>
                    </div>
                </div>

                <!-- BRANDS SECTION -->
                <div class="filter-section" th:if="${brandFilters != null and !brandFilters.isEmpty()}">
                    <h3 class="filter-title" th:text="#{category.filter.brand}">Marki</h3>
                    <div class="filter-group">
                        <label class="filter-option" th:each="brand : ${brandFilters}">
                            <input type="checkbox" name="brands" th:value="${brand.id}"
                                   th:checked="${selectedBrands.contains(brand.id)}">
                            <span th:text="${brand.name}">Marka</span>
                            <span class="filter-count" th:text="'(' + ${brand.count} + ')'"></span>
                        </label>
                    </div>
                </div>

                <!-- PRICE RANGE SECTION -->
                <div class="filter-section">
                    <h3 class="filter-title" th:text="#{category.filter.price}">Cena</h3>
                    <div class="price-inputs">
                        <input type="number" name="minPrice" th:placeholder="#{category.filter.price.min}"
                               th:value="${currentMinPrice}" min="0" step="1">
                        <span>-</span>
                        <input type="number" name="maxPrice" th:placeholder="#{category.filter.price.max}"
                               th:value="${currentMaxPrice}" min="0" step="1">
                        <span th:text="#{general.currency}">z≈Ç</span>
                    </div>
                </div>

                <!-- Preserve sort parameter -->
                <input type="hidden" name="sort" th:value="${currentSort}">

                <!-- APPLY FILTERS BUTTON -->
                <div class="filter-actions">
                    <button type="submit" class="btn-apply-filters" th:text="#{category.filter.apply}">Zastosuj filtry</button>
                    <a th:href="@{/category/{slug}(slug=${category.slug})}" class="btn-clear-filters" th:text="#{category.filter.clear}">Wyczy≈õƒá</a>
                </div>
            </form>
        </aside>

        <!-- PRODUCTS SECTION -->
        <div class="products-section">
            
            <!-- SORTING BAR ABOVE PRODUCTS -->
            <div class="sorting-bar">
                <div class="sorting-info">
                    <span th:text="#{category.showing}">Wy≈õwietlanie</span>
                    <strong th:text="${totalProducts}">0</strong>
                    <span th:text="#{category.products}">produkt√≥w</span>
                </div>
                <div class="sort-controls">
                    <label th:text="#{category.sort}">Sortuj:</label>
                    <select id="sortSelect" onchange="updateSort(this.value)">
                        <option value="newest" th:selected="${currentSort == 'newest' or currentSort == null}"
                                th:text="#{category.sort.default}">Domy≈õlnie</option>
                        <option value="price-asc" th:selected="${currentSort == 'price-asc'}"
                                th:text="#{category.sort.price.asc}">Cena: rosnƒÖco</option>
                        <option value="price-desc" th:selected="${currentSort == 'price-desc'}"
                                th:text="#{category.sort.price.desc}">Cena: malejƒÖco</option>
                        <option value="name-asc" th:selected="${currentSort == 'name-asc'}"
                                th:text="#{category.sort.name.asc}">Nazwa: A-Z</option>
                        <option value="name-desc" th:selected="${currentSort == 'name-desc'}"
                                th:text="#{category.sort.name.desc}">Nazwa: Z-A</option>
                        <option value="rating" th:selected="${currentSort == 'rating'}"
                                th:text="#{category.sort.rating}">Ocena</option>
                    </select>
                </div>
            </div>

            <!-- ACTIVE FILTERS TAGS -->
            <div class="active-filters" th:if="${!activeFilters.isEmpty()}">
                <span th:each="filter : ${activeFilters}" class="filter-tag">
                    <span th:text="${filter.label}">Filtr</span>
                </span>
            </div>

            <!-- PRODUCTS GRID -->
            <div th:if="${!products.isEmpty()}" class="products-grid">
                <a th:each="product : ${products}"
                   th:href="@{/product/{id}(id=${product.id})}"
                   class="product-card">

                    <!-- Discount Badge -->
                    <div th:if="${product.hasDiscount}" class="product-badge"
                         th:text="'-' + ${product.discountPercent} + '%'">-25%</div>

                    <div class="product-image" th:text="${product.imageUrl}">ü¶¥</div>

                    <div class="product-info">
                        <h3 class="product-name" th:text="${product.name}">Nazwa produktu</h3>

                        <p class="product-desc" th:text="${product.shortDescription}">Opis produktu</p>

                        <div class="product-footer">
                            <div class="product-pricing">
                                <span class="old-price" th:if="${product.hasDiscount}"
                                      th:text="${#numbers.formatDecimal(product.oldPrice, 1, 2)} + ' ' + #{general.currency}">0.00 z≈Ç</span>
                                <span class="product-price"
                                      th:text="${#numbers.formatDecimal(product.currentPrice, 1, 2)} + ' ' + #{general.currency}">0.00 z≈Ç</span>
                            </div>

                            <form th:action="@{/cart/add}" method="post" style="margin: 0;">
                                <input type="hidden" name="productId" th:value="${product.id}">
                                <input type="hidden" name="quantity" value="1">
                                <button type="submit"
                                        class="btn-add-cart"
                                        th:disabled="${!product.available}"
                                        th:text="#{home.add.to.cart}">
                                    Do koszyka
                                </button>
                            </form>
                        </div>
                    </div>
                </a>
            </div>

            <!-- EMPTY STATE -->
            <div th:if="${products.isEmpty()}" class="empty-state">
                <div class="empty-icon">üì¶</div>
                <h2 class="empty-title" th:text="#{search.no.results}">Brak wynik√≥w</h2>
                <p class="empty-text">Spr√≥buj zmieniƒá filtry lub wr√≥ƒá do strony g≈Ç√≥wnej</p>
                <a th:href="@{/}" class="btn-primary" th:text="#{breadcrumb.home}">Strona g≈Ç√≥wna</a>
            </div>

            <!-- PAGINATION -->
            <div class="pagination" th:if="${productPage.totalPages > 1}">
                <a th:if="${productPage.number > 0}"
                   th:href="@{/category/{slug}(slug=${category.slug}, page=${productPage.number - 1}, sort=${currentSort}, minPrice=${currentMinPrice}, maxPrice=${currentMaxPrice})}"
                   class="pagination-btn">‚Üê Poprzednia</a>
                <span class="pagination-info">
                    <span th:text="${productPage.number + 1}">1</span> / <span th:text="${productPage.totalPages}">1</span>
                </span>
                <a th:if="${productPage.number < productPage.totalPages - 1}"
                   th:href="@{/category/{slug}(slug=${category.slug}, page=${productPage.number + 1}, sort=${currentSort}, minPrice=${currentMinPrice}, maxPrice=${currentMaxPrice})}"
                   class="pagination-btn">Nastƒôpna ‚Üí</a>
            </div>
        </div>
    </div>
</div>

<!-- Mobile filter button -->
<button class="mobile-filter-btn" onclick="toggleFilters()" th:text="#{category.filter.show}">üîç Filtry</button>

<!-- FOOTER -->
<footer>
    <p th:text="#{footer.copyright}">&copy; 2026 PetMarket - Wszystkie prawa zastrze≈ºone</p>
</footer>

<script>
    function updateSort(sortValue) {
        const form = document.getElementById('filterForm');
        const sortInput = form.querySelector('input[name="sort"]');
        sortInput.value = sortValue;
        form.submit();
    }

    function toggleFilters() {
        const sidebar = document.querySelector('.sidebar');
        sidebar.classList.toggle('mobile-open');
    }
</script>

</body>
</html>