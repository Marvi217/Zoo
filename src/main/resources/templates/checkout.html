<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podsumowanie zam√≥wienia - PetMarket</title>
    <link rel="stylesheet" href="/css/public-styles.css">
</head>
<body>

<div th:replace="~{fragments/header :: navbar}"></div>
<div th:replace="~{fragments/header :: categoryBar}"></div>

<div class="breadcrumb">
    <a th:href="@{/}">Strona g≈Ç√≥wna</a> / <a th:href="@{/cart}">Koszyk</a> / Zam√≥wienie
</div>

<main class="container">
    <div class="checkout-layout">

        <section>
            <h2 class="section-title">üìù Dane dostawy i p≈Çatno≈õci</h2>
            <div class="card">
                <form th:action="@{/checkout/process}" method="post" id="checkoutForm">

                    <div class="method-group">
                        <span class="method-title">üöö Wybierz spos√≥b dostawy</span>
                        <label class="option-item">
                            <input type="radio" name="deliveryMethod" value="COURIER" required checked onchange="showAddressSection(true)">
                            <div class="option-content">
                                <strong>Kurier InPost</strong><br>
                                <small>Dostawa 1-2 dni | 14.99 z≈Ç</small>
                            </div>
                        </label>
                        <label class="option-item">
                            <input type="radio" name="deliveryMethod" value="PACZKOMAT" required onchange="showAddressSection(false)">
                            <div class="option-content">
                                <strong>Paczkomat InPost</strong><br>
                                <small>Odbi√≥r w punkcie | 12.99 z≈Ç</small>
                            </div>
                        </label>
                    </div>

                    <div id="addressSection" class="address-section show">
                        <h3>üìç Adres dostawy</h3>

                        <div th:if="${!savedAddresses.isEmpty()}" class="saved-addresses">
                            <div th:each="address, iterStat : ${savedAddresses}"
                                 class="address-card-select"
                                 th:classappend="${iterStat.first} ? 'selected' : ''"
                                 onclick="selectAddress(this)">

                                <input type="radio" name="addressId"
                                       th:value="${address.id}"
                                       th:checked="${iterStat.first}"
                                       onclick="event.stopPropagation()">

                                <div class="address-card-content">
                                    <div class="address-label" th:text="${address.label}">Dom</div>
                                    <small th:text="${address.name} + ', ' + ${address.street} + ' ' + ${address.city}"></small>
                                </div>
                            </div>

                            <button type="button" class="btn-other-address" style="width:100%; padding:10px; cursor:pointer;" onclick="showNewAddressForm()">
                                + U≈ºyj innego adresu
                            </button>
                        </div>

                        <div id="newAddressForm" class="new-address-form" th:classappend="${savedAddresses.isEmpty()} ? 'show' : ''">
                            <div class="form-group">
                                <label>Imiƒô i nazwisko *</label>
                                <input type="text" name="shippingName" placeholder="Jan Kowalski">
                            </div>
                            <div class="form-group">
                                <label>Ulica i numer *</label>
                                <input type="text" name="shippingStreet" placeholder="ul. Kwiatowa 5">
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Kod pocztowy *</label>
                                    <input type="text" name="shippingZipCode" placeholder="00-001">
                                </div>
                                <div class="form-group">
                                    <label>Miasto *</label>
                                    <input type="text" name="shippingCity" placeholder="Warszawa">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Telefon *</label>
                                <input type="tel" name="shippingPhone" placeholder="123456789">
                            </div>
                        </div>
                    </div>

                    <!-- VOUCHER CODE -->
                    <div class="method-group">
                        <span class="method-title">üéüÔ∏è Kod rabatowy</span>
                        <div class="form-group">
                            <div style="display: flex; gap: 10px;">
                                <input type="text" name="voucherCode" id="voucherCode"
                                       placeholder="Wpisz kod rabatowy"
                                       style="flex: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px;">
                                <button type="button" onclick="applyVoucher()"
                                        style="background: var(--brand-green); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Zastosuj
                                </button>
                            </div>
                            <div id="voucherMessage" style="margin-top: 8px; font-size: 14px;"></div>
                        </div>
                    </div>

                    <div class="method-group">
                        <span class="method-title">üí≥ Wybierz formƒô p≈Çatno≈õci</span>
                        <label class="option-item">
                            <input type="radio" name="paymentMethod" value="ONLINE" required checked>
                            <span>P≈Çatno≈õƒá online (BLIK, Karta)</span>
                        </label>
                        <label class="option-item">
                            <input type="radio" name="paymentMethod" value="COD" required>
                            <span>P≈Çatno≈õƒá przy odbiorze</span>
                        </label>
                    </div>

                    <button type="submit" class="btn-confirm">ZAMAWIAM I P≈ÅACƒò</button>
                </form>
            </div>
        </section>

        <aside>
            <h2 class="section-title">üì¶ Twoje zam√≥wienie</h2>
            <div class="card">
                <div th:each="item : ${cartItems}" class="summary-item">
                    <span th:text="${item.product.name} + ' x' + ${item.quantity}">Produkt</span>
                    <span th:text="${#numbers.formatDecimal(item.subtotal, 1, 2)} + ' z≈Ç'">0.00</span>
                </div>
                <div id="discountRow" style="display: none;" class="summary-item">
                    <span style="color: var(--accent-orange);">üéüÔ∏è Rabat:</span>
                    <span id="discountAmount" style="color: var(--accent-orange);">-0.00 z≈Ç</span>
                </div>
                <div class="summary-item">
                    <span>Dostawa:</span>
                    <span th:text="${total >= 199 ? 'GRATIS' : '14.99 z≈Ç'}">14.99 z≈Ç</span>
                </div>
                <div class="total-row">
                    <span>Razem:</span>
                    <span id="totalAmount" th:text="${#numbers.formatDecimal(total + (total >= 199 ? 0 : 14.99), 1, 2)} + ' z≈Ç'">0.00</span>
                </div>
                <input type="hidden" id="originalTotal" th:value="${total}">
                <input type="hidden" id="deliveryCost" th:value="${total >= 199 ? 0 : 14.99}">
            </div>
        </aside>
    </div>
</main>

<script>
    function showAddressSection(show) {
        document.getElementById('addressSection').style.display = show ? 'block' : 'none';
    }

    function selectAddress(element) {
        // Zaznaczanie wizualne
        document.querySelectorAll('.address-card-select').forEach(card => card.classList.remove('selected'));
        element.classList.add('selected');

        // Zaznaczanie radio
        const radio = element.querySelector('input[type="radio"]');
        radio.checked = true;

        // Ukrycie nowego formularza i USUNIƒòCIE REQUIRED
        const newForm = document.getElementById('newAddressForm');
        newForm.classList.remove('show');
        newForm.querySelectorAll('input').forEach(i => i.removeAttribute('required'));
    }

    function showNewAddressForm() {
        const newForm = document.getElementById('newAddressForm');
        newForm.classList.add('show');

        // Odznaczanie zapisanych
        document.querySelectorAll('input[name="addressId"]').forEach(r => r.checked = false);
        document.querySelectorAll('.address-card-select').forEach(c => c.classList.remove('selected'));

        // DODANIE REQUIRED do p√≥l
        newForm.querySelectorAll('input').forEach(i => {
            if(i.type !== 'checkbox' && i.type !== 'hidden') i.setAttribute('required', 'required');
        });
    }

    // Voucher code handling
    let appliedDiscount = 0;

    function applyVoucher() {
        const code = document.getElementById('voucherCode').value.trim();
        const messageDiv = document.getElementById('voucherMessage');

        if (!code) {
            messageDiv.innerHTML = '<span style="color: #dc2626;">‚ö†Ô∏è Wpisz kod rabatowy</span>';
            return;
        }

        fetch('/checkout/validate-voucher?code=' + encodeURIComponent(code) + '&total=' + document.getElementById('originalTotal').value)
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    appliedDiscount = data.discount;
                    messageDiv.innerHTML = '<span style="color: #16a34a;">‚úì ' + data.message + '</span>';

                    // Show discount row
                    document.getElementById('discountRow').style.display = 'flex';
                    document.getElementById('discountAmount').textContent = '-' + appliedDiscount.toFixed(2) + ' z≈Ç';

                    // Update total
                    const originalTotal = parseFloat(document.getElementById('originalTotal').value);
                    const deliveryCost = parseFloat(document.getElementById('deliveryCost').value);
                    const newTotal = (originalTotal - appliedDiscount + deliveryCost).toFixed(2);
                    document.getElementById('totalAmount').textContent = newTotal + ' z≈Ç';

                    // Disable voucher input
                    document.getElementById('voucherCode').disabled = true;
                } else {
                    messageDiv.innerHTML = '<span style="color: #dc2626;">‚ö†Ô∏è ' + data.message + '</span>';
                    appliedDiscount = 0;
                    document.getElementById('discountRow').style.display = 'none';
                }
            })
            .catch(error => {
                messageDiv.innerHTML = '<span style="color: #dc2626;">‚ö†Ô∏è B≈ÇƒÖd walidacji kodu</span>';
                console.error('Error:', error);
            });
    }

    // AUTO-START przy za≈Çadowaniu strony
    document.addEventListener('DOMContentLoaded', function() {
        const firstAddress = document.querySelector('.address-card-select');
        if (firstAddress) {
            selectAddress(firstAddress);
        } else {
            showNewAddressForm();
        }
    });
</script>

</body>
</html>