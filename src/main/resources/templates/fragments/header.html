<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<body>

<nav th:fragment="navbar" class="navbar">
    <a th:href="@{/}" href="/" class="logo">
        ğŸ¾ <span th:text="#{app.name}">PetMarket</span>
    </a>

    <div class="search-container">
        <form th:action="@{/search/quick}" action="/search/quick" method="get" autocomplete="off">
            <label>
                <input type="text" name="q" id="search-input" 
                       th:placeholder="#{nav.search.placeholder}" 
                       placeholder="Szukaj produktÃ³w..." 
                       autocomplete="off">
            </label>
            <button type="submit" class="search-btn" th:text="#{nav.search.button}">Szukaj</button>
        </form>
        <div class="search-suggestions" id="search-suggestions"></div>
    </div>

    <div class="nav-icons">
        <!-- Link dla zalogowanych uÅ¼ytkownikÃ³w -->
        <a sec:authorize="isAuthenticated()"
           th:href="@{/account}"
           class="nav-link">
            <span style="font-size: 20px;">ğŸ‘¤</span>
            <span th:text="#{nav.account}">Konto</span>
        </a>

        <!-- Link dla niezalogowanych uÅ¼ytkownikÃ³w -->
        <a sec:authorize="!isAuthenticated()"
           th:href="@{/login}"
           class="nav-link">
            <span style="font-size: 20px;">ğŸ‘¤</span>
            <span th:text="#{nav.login}">Zaloguj siÄ™</span>
        </a>

        <a th:href="@{/cart}" class="nav-link">
            <div style="position: relative; display: inline-block;">
                ğŸ›’
                <span class="cart-badge" id="cart-badge-count"
                      th:text="${cartItemCount != null ? cartItemCount : (session.cart != null ? session.cart.totalItems : 0)}"
                      th:style="${(cartItemCount == null or cartItemCount == 0) and (session.cart == null or session.cart.totalItems == 0)} ? 'display: none;' : 'display: flex;'">
                    0
                </span>
            </div>
            <span th:text="#{nav.cart}">Koszyk</span>
        </a>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Cart count fetch
                fetch('/cart/count')
                    .then(response => response.json())
                    .then(data => {
                        const badge = document.getElementById('cart-badge-count');
                        if (badge) {
                            badge.textContent = data.count;
                            badge.style.display = data.count > 0 ? 'flex' : 'none';
                        }
                    })
                    .catch(error => console.error('Failed to fetch cart count from /cart/count:', error));

                // Search autocomplete
                const searchInput = document.getElementById('search-input');
                const suggestionsContainer = document.getElementById('search-suggestions');
                let debounceTimer;
                let selectedIndex = -1;

                if (searchInput && suggestionsContainer) {
                    searchInput.addEventListener('input', function() {
                        clearTimeout(debounceTimer);
                        const query = this.value.trim();
                        
                        if (query.length < 2) {
                            suggestionsContainer.innerHTML = '';
                            suggestionsContainer.style.display = 'none';
                            return;
                        }

                        debounceTimer = setTimeout(() => {
                            fetch('/search/api/suggestions?q=' + encodeURIComponent(query))
                                .then(response => response.json())
                                .then(suggestions => {
                                    if (suggestions.length === 0) {
                                        suggestionsContainer.innerHTML = '';
                                        suggestionsContainer.style.display = 'none';
                                        return;
                                    }

                                    selectedIndex = -1;
                                    suggestionsContainer.innerHTML = suggestions.map((s, index) => {
                                        let icon = 'ğŸ”';
                                        if (s.icon === 'history') icon = 'ğŸ•’';
                                        else if (s.icon === 'popular') icon = 'ğŸ”¥';
                                        else if (s.icon === 'category') icon = 'ğŸ“';
                                        else if (s.icon === 'product') icon = 'ğŸ›ï¸';
                                        else if (s.icon === 'promo') icon = 'ğŸ·ï¸';
                                        else if (s.icon === 'bestseller') icon = 'â­';

                                        return `
                                            <a href="${s.url}" class="suggestion-item" data-index="${index}">
                                                <span class="suggestion-icon">${icon}</span>
                                                <span class="suggestion-name">${s.name}</span>
                                                <span class="suggestion-type">${s.type}</span>
                                            </a>
                                        `;
                                    }).join('');
                                    suggestionsContainer.style.display = 'block';
                                })
                                .catch(error => console.error('Search suggestions error:', error));
                        }, 200);
                    });

                    // Keyboard navigation
                    searchInput.addEventListener('keydown', function(e) {
                        const items = suggestionsContainer.querySelectorAll('.suggestion-item');
                        if (items.length === 0) return;

                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                            updateSelection(items);
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            selectedIndex = Math.max(selectedIndex - 1, -1);
                            updateSelection(items);
                        } else if (e.key === 'Enter' && selectedIndex >= 0) {
                            e.preventDefault();
                            items[selectedIndex].click();
                        } else if (e.key === 'Escape') {
                            suggestionsContainer.style.display = 'none';
                        }
                    });

                    function updateSelection(items) {
                        items.forEach((item, index) => {
                            item.classList.toggle('selected', index === selectedIndex);
                        });
                    }

                    // Close suggestions when clicking outside
                    document.addEventListener('click', function(e) {
                        if (e.target !== searchInput && 
                            !searchInput.contains(e.target) && 
                            !suggestionsContainer.contains(e.target)) {
                            suggestionsContainer.style.display = 'none';
                        }
                    });

                    // Show suggestions on focus if input has value
                    searchInput.addEventListener('focus', function() {
                        if (this.value.trim().length >= 2 && suggestionsContainer.innerHTML.trim()) {
                            suggestionsContainer.style.display = 'block';
                        }
                    });
                }
            });
        </script>
    </div>
</nav>

<!-- CATEGORY BAR FRAGMENT -->
<div th:fragment="categoryBar" class="category-bar" th:if="${globalCategories != null and !#lists.isEmpty(globalCategories)}">
    <a th:each="category : ${globalCategories}"
       th:href="@{/category/{slug}(slug=${category.slug})}"
       class="category-link">
        <span th:text="${category.icon}">ğŸ“¦</span>
        <span th:text="${category.name}">Kategoria</span>
    </a>
</div>

</body>
</html>